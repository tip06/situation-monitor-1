<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Situation Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --border: #2a2a2a;
            --text: #e8e8e8;
            --text-dim: #888;
            --accent: #fff;
            --red: #ff4444;
            --green: #44ff88;
            --yellow: #ffaa00;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            line-height: 1.5;
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .title {
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .status {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .status.loading {
            color: var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .refresh-btn, .settings-btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 0.4rem 1.2rem;
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .settings-btn {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .refresh-btn:hover, .settings-btn:hover {
            opacity: 0.8;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.open {
            display: flex;
        }

        .settings-content {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-title {
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-section {
            margin-bottom: 1rem;
        }

        .settings-section-title {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .panel-toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .panel-toggle-item label {
            font-size: 0.75rem;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--surface);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.on {
            background: var(--green);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--text);
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.on::after {
            transform: translateX(16px);
        }

        .settings-close {
            margin-top: 1rem;
            width: 100%;
            padding: 0.6rem;
            background: var(--accent);
            color: var(--bg);
            border: none;
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: auto auto;
            gap: 1px;
            background: var(--border);
        }

        .panel {
            background: var(--bg);
            display: flex;
            flex-direction: column;
            min-height: 300px;
            transition: min-height 0.2s, opacity 0.2s;
        }

        .panel.hidden {
            min-height: 0;
            display: none;
        }

        .panel.wide {
            grid-column: span 2;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .panel-header:hover {
            background: var(--surface);
        }

        .panel-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-toggle {
            font-size: 0.6rem;
            color: var(--text-dim);
            transition: transform 0.2s;
        }

        .panel.collapsed .panel-toggle {
            transform: rotate(-90deg);
        }

        .panel-title {
            font-size: 0.65rem;
            font-weight: bold;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .panel-count {
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            max-height: 380px;
            transition: max-height 0.2s;
        }

        .panel.collapsed .panel-content {
            max-height: 0;
            overflow: hidden;
        }

        .panel.collapsed {
            min-height: auto;
        }

        .item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .item:hover {
            background: var(--surface);
        }

        .item.alert {
            border-left: 2px solid var(--yellow);
        }

        .item-source {
            font-size: 0.55rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.15rem;
        }

        .item-title {
            font-size: 0.75rem;
            font-weight: normal;
            color: var(--text);
            text-decoration: none;
            display: block;
        }

        .item-title:hover {
            color: var(--accent);
        }

        .item-time {
            font-size: 0.55rem;
            color: var(--text-dim);
            margin-top: 0.3rem;
        }

        .alert-tag {
            font-size: 0.5rem;
            background: var(--yellow);
            color: var(--bg);
            padding: 0.1rem 0.3rem;
            margin-left: 0.5rem;
            font-weight: bold;
        }

        /* Markets Panel */
        .market-item {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .market-name {
            font-size: 0.7rem;
            font-weight: bold;
        }

        .market-symbol {
            font-size: 0.55rem;
            color: var(--text-dim);
        }

        .market-data {
            text-align: right;
        }

        .market-price {
            font-size: 0.75rem;
            font-weight: bold;
        }

        .market-change {
            font-size: 0.65rem;
        }

        .market-change.up {
            color: var(--green);
        }

        .market-change.down {
            color: var(--red);
        }

        /* Sector Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            padding: 0.5rem;
        }

        .heatmap-cell {
            padding: 0.6rem 0.4rem;
            text-align: center;
            font-size: 0.6rem;
            font-weight: bold;
            border-radius: 2px;
        }

        .heatmap-cell .sector-name {
            font-size: 0.55rem;
            opacity: 0.9;
            margin-bottom: 0.2rem;
        }

        .heatmap-cell .sector-change {
            font-size: 0.7rem;
        }

        .heatmap-cell.up-3 { background: #0d5a2d; color: #fff; }
        .heatmap-cell.up-2 { background: #157a3c; color: #fff; }
        .heatmap-cell.up-1 { background: #1d9a4b; color: #fff; }
        .heatmap-cell.up-0 { background: #2a4a35; color: #fff; }
        .heatmap-cell.down-0 { background: #4a2a2a; color: #fff; }
        .heatmap-cell.down-1 { background: #8a3a3a; color: #fff; }
        .heatmap-cell.down-2 { background: #aa3333; color: #fff; }
        .heatmap-cell.down-3 { background: #cc2222; color: #fff; }

        /* Polymarket */
        .prediction-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .prediction-question {
            font-size: 0.75rem;
            flex: 1;
            color: var(--text);
        }

        .prediction-odds {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .prediction-yes, .prediction-no {
            padding: 0.25rem 0.5rem;
            font-size: 0.65rem;
            font-weight: bold;
            border-radius: 2px;
        }

        .prediction-yes {
            background: var(--green);
            color: var(--bg);
        }

        .prediction-no {
            background: var(--red);
            color: #fff;
        }

        .prediction-volume {
            font-size: 0.55rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        .error-msg {
            padding: 1rem;
            color: var(--text-dim);
            font-size: 0.7rem;
        }

        /* Global Map - Situation Room Style */
        .world-map {
            width: 100%;
            height: 400px;
            position: relative;
            background: #020a08;
            overflow: hidden;
            border: 1px solid #0a3020;
        }

        .world-map::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 40, 30, 0.03) 2px,
                rgba(0, 40, 30, 0.03) 4px
            );
            pointer-events: none;
            z-index: 10;
        }

        .world-map svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .coord-label {
            position: absolute;
            font-size: 0.5rem;
            color: #0f6040;
            font-family: 'SF Mono', monospace;
            pointer-events: none;
            z-index: 5;
        }

        .coord-label.lat {
            left: 5px;
            transform: translateY(-50%);
        }

        .coord-label.lon {
            bottom: 3px;
            transform: translateX(-50%);
        }

        .map-corner-label {
            position: absolute;
            font-size: 0.5rem;
            color: #0f6040;
            font-family: 'SF Mono', monospace;
            letter-spacing: 0.1em;
            z-index: 15;
        }

        .map-corner-label.tl { top: 8px; left: 10px; }
        .map-corner-label.tr { top: 8px; right: 10px; }
        .map-corner-label.bl { bottom: 8px; left: 10px; }
        .map-corner-label.br { bottom: 8px; right: 10px; }

        .hotspot {
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
        }

        .hotspot-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
            border: 1px solid;
        }

        .hotspot-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: pulse-ring 2s ease-out infinite;
        }

        .hotspot-dot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid;
            opacity: 0.4;
        }

        .hotspot.low .hotspot-dot {
            background: #00ff88;
            border-color: #00ff88;
            box-shadow: 0 0 10px #00ff88, 0 0 20px rgba(0,255,136,0.3);
        }
        .hotspot.low .hotspot-dot::before { background: #00ff88; }
        .hotspot.low .hotspot-dot::after { border-color: #00ff88; }

        .hotspot.elevated .hotspot-dot {
            background: #ffcc00;
            border-color: #ffcc00;
            box-shadow: 0 0 10px #ffcc00, 0 0 20px rgba(255,204,0,0.3);
        }
        .hotspot.elevated .hotspot-dot::before { background: #ffcc00; }
        .hotspot.elevated .hotspot-dot::after { border-color: #ffcc00; }

        .hotspot.high .hotspot-dot {
            background: #ff3333;
            border-color: #ff3333;
            box-shadow: 0 0 15px #ff3333, 0 0 30px rgba(255,51,51,0.4);
            animation: glow-high 1s ease-in-out infinite alternate;
        }
        .hotspot.high .hotspot-dot::before { background: #ff3333; }
        .hotspot.high .hotspot-dot::after { border-color: #ff3333; animation: target-lock 1.5s linear infinite; }

        @keyframes pulse-ring {
            0% { width: 100%; height: 100%; opacity: 0.6; }
            100% { width: 250%; height: 250%; opacity: 0; }
        }

        @keyframes glow-high {
            from { box-shadow: 0 0 10px #ff3333, 0 0 20px rgba(255,51,51,0.3); }
            to { box-shadow: 0 0 20px #ff3333, 0 0 40px rgba(255,51,51,0.5); }
        }

        @keyframes target-lock {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .hotspot-label {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.55rem;
            font-family: 'SF Mono', monospace;
            color: #00ff88;
            white-space: nowrap;
            text-shadow: 0 0 5px rgba(0,255,136,0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .hotspot.elevated .hotspot-label { color: #ffcc00; text-shadow: 0 0 5px rgba(255,204,0,0.5); }
        .hotspot.high .hotspot-label { color: #ff3333; text-shadow: 0 0 5px rgba(255,51,51,0.5); }

        .hotspot-info {
            font-size: 0.45rem;
            color: #0a8060;
            text-transform: none;
        }

        .loading-msg {
            padding: 1rem;
            color: var(--text-dim);
            font-size: 0.7rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Congressional Trades */
        .congress-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .congress-info {
            flex: 1;
            min-width: 0;
        }

        .congress-name {
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--text);
        }

        .congress-party {
            font-size: 0.55rem;
            padding: 0.1rem 0.3rem;
            border-radius: 2px;
            margin-left: 0.4rem;
        }

        .congress-party.D { background: #2266cc; color: #fff; }
        .congress-party.R { background: #cc2222; color: #fff; }
        .congress-party.I { background: #666; color: #fff; }

        .congress-ticker {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent);
            margin-top: 0.2rem;
        }

        .congress-meta {
            font-size: 0.55rem;
            color: var(--text-dim);
            margin-top: 0.15rem;
        }

        .congress-type {
            text-align: right;
        }

        .congress-action {
            font-size: 0.65rem;
            font-weight: bold;
            padding: 0.2rem 0.4rem;
            border-radius: 2px;
        }

        .congress-action.buy { background: var(--green); color: var(--bg); }
        .congress-action.sell { background: var(--red); color: #fff; }

        .congress-amount {
            font-size: 0.55rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        /* Whale Watch */
        .whale-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .whale-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .whale-coin {
            font-size: 0.7rem;
            font-weight: bold;
        }

        .whale-amount {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--accent);
        }

        .whale-usd {
            font-size: 0.55rem;
            color: var(--text-dim);
        }

        .whale-flow {
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-top: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .whale-flow .arrow {
            color: var(--yellow);
        }

        /* Main Character */
        .main-char-display {
            padding: 1.5rem 1rem;
            text-align: center;
        }

        .main-char-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .main-char-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 0.3rem;
        }

        .main-char-count {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .main-char-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .char-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 1rem;
            font-size: 0.7rem;
        }

        .char-row .rank {
            color: var(--text-dim);
            width: 1.5rem;
        }

        .char-row .name {
            flex: 1;
        }

        .char-row .mentions {
            color: var(--text-dim);
        }

        /* Contracts */
        .contract-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .contract-agency {
            font-size: 0.55rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .contract-desc {
            font-size: 0.75rem;
            color: var(--text);
            margin-top: 0.2rem;
        }

        .contract-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.3rem;
        }

        .contract-vendor {
            font-size: 0.6rem;
            color: var(--text-dim);
        }

        .contract-value {
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--green);
        }

        /* AI Tracker */
        .ai-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .ai-source {
            font-size: 0.55rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ai-title {
            font-size: 0.75rem;
            color: var(--text);
            margin-top: 0.15rem;
        }

        .ai-date {
            font-size: 0.55rem;
            color: var(--text-dim);
            margin-top: 0.2rem;
        }

        /* Money Printer Gauge */
        .printer-gauge {
            padding: 1.5rem 1rem;
            text-align: center;
        }

        .printer-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
        }

        .printer-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }

        .printer-unit {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-left: 0.3rem;
        }

        .printer-change {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .printer-change.up { color: var(--red); }
        .printer-change.down { color: var(--green); }

        .printer-bar {
            margin-top: 1rem;
            height: 8px;
            background: var(--surface);
            border-radius: 4px;
            overflow: hidden;
        }

        .printer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--yellow), var(--red));
            transition: width 0.5s ease;
        }

        .printer-status {
            margin-top: 0.75rem;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .printer-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.4rem;
            animation: blink 1s infinite;
        }

        .printer-indicator.on { background: var(--red); }
        .printer-indicator.off { background: var(--green); }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .section-divider {
            padding: 0.4rem 1rem;
            background: var(--surface);
            font-size: 0.55rem;
            font-weight: bold;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            .panel.wide {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 0.75rem 1rem;
            }

            .panel-content {
                max-height: 350px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1 class="title">Situation Monitor</h1>
            <span class="status" id="status">Ready</span>
        </div>
        <div class="header-right">
            <button class="settings-btn" onclick="toggleSettings()">Panels</button>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshAll()">Refresh</button>
        </div>
    </header>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal" onclick="if(event.target === this) toggleSettings()">
        <div class="settings-content">
            <div class="settings-title">Panel Settings</div>
            <div class="settings-section">
                <div class="settings-section-title">Toggle Panels</div>
                <div id="panelToggles"></div>
            </div>
            <button class="settings-close" onclick="toggleSettings()">Close</button>
        </div>
    </div>

    <main class="dashboard">
        <!-- Global Intelligence Map -->
        <section class="panel" data-panel="map" style="grid-column: span 4;">
            <div class="panel-header">
                <span class="panel-title">Global Activity Monitor</span>
                <span class="panel-count" id="mapLegend">
                    <span style="color: var(--green);">● Low</span>
                    <span style="color: var(--yellow); margin-left: 0.5rem;">● Elevated</span>
                    <span style="color: var(--red); margin-left: 0.5rem;">● High</span>
                </span>
            </div>
            <div class="panel-content" id="mapPanel" style="max-height: none; height: 350px; overflow: hidden;">
                <div class="loading-msg">Loading map...</div>
            </div>
        </section>

        <!-- Political / World News -->
        <section class="panel" data-panel="politics">
            <div class="panel-header">
                <span class="panel-title">World / Geopolitical</span>
                <span class="panel-count" id="politicsCount">-</span>
            </div>
            <div class="panel-content" id="politicsPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Technology News -->
        <section class="panel" data-panel="tech">
            <div class="panel-header">
                <span class="panel-title">Technology / AI</span>
                <span class="panel-count" id="techCount">-</span>
            </div>
            <div class="panel-content" id="techPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Financial News -->
        <section class="panel" data-panel="finance">
            <div class="panel-header">
                <span class="panel-title">Financial</span>
                <span class="panel-count" id="financeCount">-</span>
            </div>
            <div class="panel-content" id="financePanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Government / Policy -->
        <section class="panel" data-panel="gov">
            <div class="panel-header">
                <span class="panel-title">Government / Policy</span>
                <span class="panel-count" id="govCount">-</span>
            </div>
            <div class="panel-content" id="govPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Sector Heatmap -->
        <section class="panel" data-panel="heatmap">
            <div class="panel-header">
                <span class="panel-title">Sector Heatmap</span>
            </div>
            <div class="panel-content" id="heatmapPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Markets -->
        <section class="panel wide" data-panel="markets">
            <div class="panel-header">
                <span class="panel-title">Markets</span>
                <span class="panel-count" id="marketsCount">-</span>
            </div>
            <div class="panel-content" id="marketsPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Commodities -->
        <section class="panel" data-panel="commodities">
            <div class="panel-header">
                <span class="panel-title">Commodities / VIX</span>
            </div>
            <div class="panel-content" id="commoditiesPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Polymarket -->
        <section class="panel wide" data-panel="polymarket">
            <div class="panel-header">
                <span class="panel-title">Polymarket Predictions</span>
                <span class="panel-count" id="polymarketCount">-</span>
            </div>
            <div class="panel-content" id="polymarketPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Congressional Trading -->
        <section class="panel" data-panel="congress">
            <div class="panel-header">
                <span class="panel-title">Congress Trades</span>
                <span class="panel-count" id="congressCount">-</span>
            </div>
            <div class="panel-content" id="congressPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Whale Wallet Watch -->
        <section class="panel" data-panel="whales">
            <div class="panel-header">
                <span class="panel-title">Whale Watch</span>
                <span class="panel-count" id="whaleCount">-</span>
            </div>
            <div class="panel-content" id="whalePanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Main Character -->
        <section class="panel" data-panel="mainchar">
            <div class="panel-header">
                <span class="panel-title">Main Character</span>
                <span class="panel-count">Today</span>
            </div>
            <div class="panel-content" id="mainCharPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Money Printer -->
        <section class="panel" data-panel="printer">
            <div class="panel-header">
                <span class="panel-title">Money Printer</span>
                <span class="panel-count">Fed Balance Sheet</span>
            </div>
            <div class="panel-content" id="printerPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Government Contracts -->
        <section class="panel wide" data-panel="contracts">
            <div class="panel-header">
                <span class="panel-title">Gov Contracts</span>
                <span class="panel-count" id="contractsCount">-</span>
            </div>
            <div class="panel-content" id="contractsPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- AI Arms Race -->
        <section class="panel wide" data-panel="ai">
            <div class="panel-header">
                <span class="panel-title">AI Arms Race</span>
                <span class="panel-count" id="aiCount">-</span>
            </div>
            <div class="panel-content" id="aiPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

    </main>

    <script>
        // Panel configuration with display names
        const PANELS = {
            map: { name: 'Global Map', priority: 1 },
            politics: { name: 'World / Geopolitical', priority: 1 },
            tech: { name: 'Technology / AI', priority: 1 },
            finance: { name: 'Financial', priority: 1 },
            gov: { name: 'Government / Policy', priority: 2 },
            heatmap: { name: 'Sector Heatmap', priority: 1 },
            markets: { name: 'Markets', priority: 1 },
            commodities: { name: 'Commodities / VIX', priority: 2 },
            polymarket: { name: 'Polymarket', priority: 2 },
            congress: { name: 'Congress Trades', priority: 3 },
            whales: { name: 'Whale Watch', priority: 3 },
            mainchar: { name: 'Main Character', priority: 2 },
            printer: { name: 'Money Printer', priority: 2 },
            contracts: { name: 'Gov Contracts', priority: 3 },
            ai: { name: 'AI Arms Race', priority: 3 }
        };

        // Load panel visibility from localStorage
        function getPanelSettings() {
            try {
                const saved = localStorage.getItem('situationMonitorPanels');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                return {};
            }
        }

        // Save panel visibility to localStorage
        function savePanelSettings(settings) {
            try {
                localStorage.setItem('situationMonitorPanels', JSON.stringify(settings));
            } catch (e) {}
        }

        // Check if panel is enabled
        function isPanelEnabled(panelId) {
            const settings = getPanelSettings();
            return settings[panelId] !== false; // Default to enabled
        }

        // Toggle panel visibility
        function togglePanel(panelId) {
            const settings = getPanelSettings();
            settings[panelId] = !isPanelEnabled(panelId);
            savePanelSettings(settings);
            applyPanelSettings();
            updateSettingsUI();
        }

        // Apply panel settings to DOM
        function applyPanelSettings() {
            document.querySelectorAll('[data-panel]').forEach(panel => {
                const panelId = panel.dataset.panel;
                if (isPanelEnabled(panelId)) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
        }

        // Toggle settings modal
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('open');
            if (modal.classList.contains('open')) {
                updateSettingsUI();
            }
        }

        // Update settings UI
        function updateSettingsUI() {
            const container = document.getElementById('panelToggles');
            container.innerHTML = Object.entries(PANELS).map(([id, config]) => {
                const enabled = isPanelEnabled(id);
                return `
                    <div class="panel-toggle-item">
                        <label onclick="togglePanel('${id}')">${config.name}</label>
                        <div class="toggle-switch ${enabled ? 'on' : ''}" onclick="togglePanel('${id}')"></div>
                    </div>
                `;
            }).join('');
        }

        // Initialize panel settings on load
        document.addEventListener('DOMContentLoaded', applyPanelSettings);

        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url='
        ];

        // Geopolitical alert keywords
        const ALERT_KEYWORDS = [
            'war', 'invasion', 'military', 'nuclear', 'sanctions', 'missile',
            'attack', 'troops', 'conflict', 'strike', 'bomb', 'casualties',
            'ceasefire', 'treaty', 'nato', 'coup', 'martial law', 'emergency',
            'assassination', 'terrorist', 'hostage', 'evacuation'
        ];

        // RSS Feed sources
        const FEEDS = {
            politics: [
                { name: 'BBC World', url: 'https://feeds.bbci.co.uk/news/world/rss.xml' },
                { name: 'NPR News', url: 'https://feeds.npr.org/1001/rss.xml' },
                { name: 'Guardian World', url: 'https://www.theguardian.com/world/rss' },
                { name: 'Reuters World', url: 'https://www.reutersagency.com/feed/?taxonomy=best-sectors&post_type=best' }
            ],
            tech: [
                { name: 'Hacker News', url: 'https://hnrss.org/frontpage' },
                { name: 'Ars Technica', url: 'https://feeds.arstechnica.com/arstechnica/technology-lab' },
                { name: 'The Verge', url: 'https://www.theverge.com/rss/index.xml' },
                { name: 'MIT Tech Review', url: 'https://www.technologyreview.com/feed/' },
                { name: 'ArXiv AI', url: 'https://rss.arxiv.org/rss/cs.AI' },
                { name: 'OpenAI Blog', url: 'https://openai.com/blog/rss.xml' }
            ],
            finance: [
                { name: 'CNBC', url: 'https://www.cnbc.com/id/100003114/device/rss/rss.html' },
                { name: 'MarketWatch', url: 'https://feeds.marketwatch.com/marketwatch/topstories' },
                { name: 'Yahoo Finance', url: 'https://finance.yahoo.com/news/rssindex' },
                { name: 'Reuters Business', url: 'https://www.reutersagency.com/feed/?best-topics=business-finance&post_type=best' },
                { name: 'FT', url: 'https://www.ft.com/rss/home' }
            ],
            gov: [
                { name: 'White House', url: 'https://www.whitehouse.gov/feed/' },
                { name: 'Federal Reserve', url: 'https://www.federalreserve.gov/feeds/press_all.xml' },
                { name: 'SEC Announcements', url: 'https://www.sec.gov/news/pressreleases.rss' },
                { name: 'Treasury', url: 'https://home.treasury.gov/system/files/136/treasury-rss.xml' },
                { name: 'State Dept', url: 'https://www.state.gov/rss-feed/press-releases/feed/' }
            ]
        };

        // Sector ETFs for heatmap
        const SECTORS = [
            { symbol: 'XLK', name: 'Tech' },
            { symbol: 'XLF', name: 'Finance' },
            { symbol: 'XLE', name: 'Energy' },
            { symbol: 'XLV', name: 'Health' },
            { symbol: 'XLY', name: 'Consumer' },
            { symbol: 'XLI', name: 'Industrial' },
            { symbol: 'XLP', name: 'Staples' },
            { symbol: 'XLU', name: 'Utilities' },
            { symbol: 'XLB', name: 'Materials' },
            { symbol: 'XLRE', name: 'Real Est' },
            { symbol: 'XLC', name: 'Comms' },
            { symbol: 'SMH', name: 'Semis' }
        ];

        // Commodities and VIX
        const COMMODITIES = [
            { symbol: '^VIX', name: 'VIX', display: 'VIX' },
            { symbol: 'GC=F', name: 'Gold', display: 'GOLD' },
            { symbol: 'CL=F', name: 'Crude Oil', display: 'OIL' },
            { symbol: 'NG=F', name: 'Natural Gas', display: 'NATGAS' },
            { symbol: 'SI=F', name: 'Silver', display: 'SILVER' },
            { symbol: 'HG=F', name: 'Copper', display: 'COPPER' }
        ];

        // Fetch with proxy
        async function fetchWithProxy(url) {
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                try {
                    const proxy = CORS_PROXIES[i];
                    const response = await fetch(proxy + encodeURIComponent(url), {
                        headers: { 'Accept': 'application/rss+xml, application/xml, text/xml, */*' }
                    });
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (e) {
                    console.log(`Proxy ${i} failed, trying next...`);
                }
            }
            throw new Error('All proxies failed');
        }

        // Check for alert keywords
        function hasAlertKeyword(title) {
            const lower = title.toLowerCase();
            return ALERT_KEYWORDS.some(kw => lower.includes(kw));
        }

        // Parse RSS feed
        async function fetchFeed(source) {
            try {
                const text = await fetchWithProxy(source.url);
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');

                const parseError = xml.querySelector('parsererror');
                if (parseError) {
                    console.error(`Parse error for ${source.name}`);
                    return [];
                }

                let items = xml.querySelectorAll('item');
                if (items.length === 0) {
                    items = xml.querySelectorAll('entry');
                }

                return Array.from(items).slice(0, 5).map(item => {
                    let link = '';
                    const linkEl = item.querySelector('link');
                    if (linkEl) {
                        link = linkEl.getAttribute('href') || linkEl.textContent || '';
                    }
                    link = link.trim();

                    const title = (item.querySelector('title')?.textContent || 'No title').trim();
                    const pubDate = item.querySelector('pubDate')?.textContent ||
                                   item.querySelector('published')?.textContent ||
                                   item.querySelector('updated')?.textContent || '';

                    return {
                        source: source.name,
                        title,
                        link,
                        pubDate,
                        isAlert: hasAlertKeyword(title)
                    };
                });
            } catch (error) {
                console.error(`Error fetching ${source.name}:`, error);
                return [];
            }
        }

        // Fetch all feeds for a category
        async function fetchCategory(feeds) {
            const results = await Promise.all(feeds.map(fetchFeed));
            const items = results.flat();

            items.sort((a, b) => {
                // Alerts first, then by date
                if (a.isAlert && !b.isAlert) return -1;
                if (!a.isAlert && b.isAlert) return 1;
                const dateA = new Date(a.pubDate);
                const dateB = new Date(b.pubDate);
                return dateB - dateA;
            });

            return items.slice(0, 20);
        }

        // Fetch stock quote
        async function fetchQuote(symbol) {
            try {
                const text = await fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`);
                const data = JSON.parse(text);
                if (data.chart?.result?.[0]) {
                    const meta = data.chart.result[0].meta;
                    const change = ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100;
                    return { price: meta.regularMarketPrice, change };
                }
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
            }
            return null;
        }

        // Fetch market data
        async function fetchMarkets() {
            const markets = [];

            const symbols = [
                { symbol: '^GSPC', name: 'S&P 500', display: 'SPX' },
                { symbol: '^DJI', name: 'Dow Jones', display: 'DJI' },
                { symbol: '^IXIC', name: 'NASDAQ', display: 'NDX' },
                { symbol: 'AAPL', name: 'Apple', display: 'AAPL' },
                { symbol: 'MSFT', name: 'Microsoft', display: 'MSFT' },
                { symbol: 'NVDA', name: 'NVIDIA', display: 'NVDA' },
                { symbol: 'GOOGL', name: 'Alphabet', display: 'GOOGL' },
                { symbol: 'AMZN', name: 'Amazon', display: 'AMZN' },
                { symbol: 'META', name: 'Meta', display: 'META' },
                { symbol: 'BRK-B', name: 'Berkshire', display: 'BRK.B' },
                { symbol: 'TSM', name: 'TSMC', display: 'TSM' },
                { symbol: 'LLY', name: 'Eli Lilly', display: 'LLY' },
                { symbol: 'TSLA', name: 'Tesla', display: 'TSLA' },
                { symbol: 'AVGO', name: 'Broadcom', display: 'AVGO' },
                { symbol: 'WMT', name: 'Walmart', display: 'WMT' },
                { symbol: 'JPM', name: 'JPMorgan', display: 'JPM' },
                { symbol: 'V', name: 'Visa', display: 'V' },
                { symbol: 'UNH', name: 'UnitedHealth', display: 'UNH' },
                { symbol: 'NVO', name: 'Novo Nordisk', display: 'NVO' },
                { symbol: 'XOM', name: 'Exxon', display: 'XOM' },
                { symbol: 'MA', name: 'Mastercard', display: 'MA' },
                { symbol: 'ORCL', name: 'Oracle', display: 'ORCL' },
                { symbol: 'PG', name: 'P&G', display: 'PG' },
                { symbol: 'COST', name: 'Costco', display: 'COST' },
                { symbol: 'JNJ', name: 'J&J', display: 'JNJ' },
                { symbol: 'HD', name: 'Home Depot', display: 'HD' },
                { symbol: 'NFLX', name: 'Netflix', display: 'NFLX' },
                { symbol: 'BAC', name: 'BofA', display: 'BAC' }
            ];

            const fetchStock = async (s) => {
                const quote = await fetchQuote(s.symbol);
                if (quote) {
                    return { name: s.name, symbol: s.display, price: quote.price, change: quote.change };
                }
                return null;
            };

            const stockResults = await Promise.all(symbols.map(fetchStock));
            stockResults.forEach(r => { if (r) markets.push(r); });

            // Crypto
            try {
                const cryptoResponse = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana&vs_currencies=usd&include_24hr_change=true');
                const crypto = await cryptoResponse.json();

                if (crypto.bitcoin) markets.push({ name: 'Bitcoin', symbol: 'BTC', price: crypto.bitcoin.usd, change: crypto.bitcoin.usd_24h_change });
                if (crypto.ethereum) markets.push({ name: 'Ethereum', symbol: 'ETH', price: crypto.ethereum.usd, change: crypto.ethereum.usd_24h_change });
                if (crypto.solana) markets.push({ name: 'Solana', symbol: 'SOL', price: crypto.solana.usd, change: crypto.solana.usd_24h_change });
            } catch (error) {
                console.error('Error fetching crypto:', error);
            }

            return markets;
        }

        // Fetch sector heatmap data
        async function fetchSectors() {
            const results = await Promise.all(SECTORS.map(async (s) => {
                const quote = await fetchQuote(s.symbol);
                if (quote) {
                    return { name: s.name, symbol: s.symbol, change: quote.change };
                }
                return { name: s.name, symbol: s.symbol, change: 0 };
            }));
            return results;
        }

        // Fetch commodities and VIX
        async function fetchCommodities() {
            const results = [];
            for (const c of COMMODITIES) {
                const quote = await fetchQuote(c.symbol);
                if (quote) {
                    results.push({ name: c.name, symbol: c.display, price: quote.price, change: quote.change });
                }
            }
            return results;
        }

        // Intelligence hotspots with coordinates (x%, y% on map)
        const INTEL_HOTSPOTS = [
            { id: 'dc', name: 'DC', subtext: 'Pentagon Pizza Index', lat: 38.9, lon: -77.0, keywords: ['pentagon', 'white house', 'washington', 'us military', 'cia', 'nsa', 'biden', 'trump'] },
            { id: 'moscow', name: 'Moscow', subtext: 'Kremlin Activity', lat: 55.75, lon: 37.6, keywords: ['russia', 'putin', 'kremlin', 'moscow', 'russian'] },
            { id: 'beijing', name: 'Beijing', subtext: 'PLA/MSS Activity', lat: 39.9, lon: 116.4, keywords: ['china', 'beijing', 'chinese', 'xi jinping', 'taiwan strait', 'pla'] },
            { id: 'kyiv', name: 'Kyiv', subtext: 'Conflict Zone', lat: 50.45, lon: 30.5, keywords: ['ukraine', 'kyiv', 'zelensky', 'ukrainian', 'donbas', 'crimea'] },
            { id: 'taipei', name: 'Taipei', subtext: 'Strait Watch', lat: 25.03, lon: 121.5, keywords: ['taiwan', 'taipei', 'taiwanese', 'strait'] },
            { id: 'tehran', name: 'Tehran', subtext: 'IRGC Activity', lat: 35.7, lon: 51.4, keywords: ['iran', 'tehran', 'iranian', 'irgc', 'hezbollah', 'nuclear'] },
            { id: 'jerusalem', name: 'Tel Aviv', subtext: 'Mossad/IDF', lat: 32.07, lon: 34.78, keywords: ['israel', 'israeli', 'gaza', 'hamas', 'idf', 'netanyahu', 'mossad'] },
            { id: 'pyongyang', name: 'Pyongyang', subtext: 'DPRK Watch', lat: 39.03, lon: 125.75, keywords: ['north korea', 'kim jong', 'pyongyang', 'dprk', 'korean missile'] },
            { id: 'london', name: 'London', subtext: 'GCHQ/MI6', lat: 51.5, lon: -0.12, keywords: ['uk', 'britain', 'british', 'mi6', 'gchq', 'london'] },
            { id: 'brussels', name: 'Brussels', subtext: 'NATO HQ', lat: 50.85, lon: 4.35, keywords: ['nato', 'eu', 'european union', 'brussels'] }
        ];

        // Convert lat/lon to map position (simple equirectangular projection)
        function latLonToXY(lat, lon, width, height) {
            const x = ((lon + 180) / 360) * width;
            const y = ((90 - lat) / 180) * height;
            return { x, y };
        }

        // Analyze news for hotspot activity
        function analyzeHotspotActivity(allNews) {
            const results = {};

            INTEL_HOTSPOTS.forEach(spot => {
                let score = 0;
                let matchedHeadlines = [];

                allNews.forEach(item => {
                    const title = item.title.toLowerCase();
                    const matchedKeywords = spot.keywords.filter(kw => title.includes(kw));
                    if (matchedKeywords.length > 0) {
                        score += matchedKeywords.length;
                        if (item.isAlert) score += 3; // Boost for alert keywords
                        matchedHeadlines.push(item.title);
                    }
                });

                let level = 'low';
                if (score >= 8) level = 'high';
                else if (score >= 3) level = 'elevated';

                results[spot.id] = { level, score, headlines: matchedHeadlines.slice(0, 3) };
            });

            return results;
        }

        // Render the global map - Situation Room Style
        function renderGlobalMap(activityData) {
            const panel = document.getElementById('mapPanel');

            let hotspotsHTML = '';

            INTEL_HOTSPOTS.forEach(spot => {
                const activity = activityData[spot.id] || { level: 'low', score: 0 };
                const xPercent = ((spot.lon + 180) / 360) * 100;
                const yPercent = ((90 - spot.lat) / 180) * 100;

                hotspotsHTML += `
                    <div class="hotspot ${activity.level}" style="left: ${xPercent}%; top: ${yPercent}%;">
                        <div class="hotspot-dot"></div>
                        <div class="hotspot-label">
                            ${spot.name}
                            <div class="hotspot-info">${spot.subtext}</div>
                        </div>
                    </div>
                `;
            });

            // Generate coordinate labels
            let coordLabels = '';
            // Latitude labels (every 30 degrees)
            [-60, -30, 0, 30, 60].forEach(lat => {
                const yPercent = ((90 - lat) / 180) * 100;
                const label = lat === 0 ? '0°' : (lat > 0 ? `${lat}°N` : `${Math.abs(lat)}°S`);
                coordLabels += `<div class="coord-label lat" style="top: ${yPercent}%">${label}</div>`;
            });
            // Longitude labels (every 60 degrees)
            [-120, -60, 0, 60, 120, 180].forEach(lon => {
                const xPercent = ((lon + 180) / 360) * 100;
                const label = lon === 0 ? '0°' : (lon > 0 ? `${lon}°E` : `${Math.abs(lon)}°W`);
                coordLabels += `<div class="coord-label lon" style="left: ${xPercent}%">${label}</div>`;
            });

            // Tactical SVG map with proper grid
            const worldMapSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 180" preserveAspectRatio="none">
                <defs>
                    <pattern id="smallGrid" width="10" height="10" patternUnits="userSpaceOnUse">
                        <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#0a2a20" stroke-width="0.3"/>
                    </pattern>
                    <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse">
                        <rect width="30" height="30" fill="url(#smallGrid)"/>
                        <path d="M 30 0 L 0 0 0 30" fill="none" stroke="#0d3a2d" stroke-width="0.5"/>
                    </pattern>
                </defs>

                <!-- Background -->
                <rect width="360" height="180" fill="#020a08"/>

                <!-- Grid -->
                <rect width="360" height="180" fill="url(#grid)"/>

                <!-- Major grid lines -->
                <g stroke="#0f4035" stroke-width="0.8">
                    <!-- Equator -->
                    <line x1="0" y1="90" x2="360" y2="90"/>
                    <!-- Prime Meridian -->
                    <line x1="180" y1="0" x2="180" y2="180"/>
                    <!-- Tropics -->
                    <line x1="0" y1="66.5" x2="360" y2="66.5" stroke-dasharray="2,2" opacity="0.5"/>
                    <line x1="0" y1="113.5" x2="360" y2="113.5" stroke-dasharray="2,2" opacity="0.5"/>
                </g>

                <!-- Continents with glow effect -->
                <g fill="#0a2018" stroke="#0f5040" stroke-width="0.5">
                    <!-- North America -->
                    <path d="M30,35 L45,28 L60,25 L75,28 L90,25 L105,30 L108,38 L100,45 L95,52 L85,58 L78,62 L70,60 L60,65 L52,60 L45,62 L38,55 L32,50 L28,42Z"/>
                    <!-- Greenland -->
                    <path d="M100,18 L115,12 L128,15 L132,22 L125,30 L112,32 L102,28Z"/>
                    <!-- South America -->
                    <path d="M65,78 L78,72 L88,80 L95,95 L92,115 L82,130 L70,132 L60,120 L58,100 L62,88Z"/>
                    <!-- Europe -->
                    <path d="M160,28 L175,24 L190,28 L198,35 L192,42 L182,45 L172,42 L165,48 L158,42 L155,35Z"/>
                    <!-- UK -->
                    <path d="M150,32 L158,30 L160,38 L154,42 L148,38Z"/>
                    <!-- Africa -->
                    <path d="M160,55 L178,50 L195,58 L205,75 L202,100 L188,118 L168,120 L155,108 L152,85 L158,68Z"/>
                    <!-- Middle East -->
                    <path d="M195,48 L212,45 L225,55 L222,68 L208,72 L195,65Z"/>
                    <!-- Russia/North Asia -->
                    <path d="M195,18 L230,12 L270,15 L305,22 L330,18 L350,25 L355,35 L345,42 L320,40 L290,45 L260,42 L230,45 L205,40 L195,32Z"/>
                    <!-- South Asia / India -->
                    <path d="M220,55 L238,50 L250,60 L252,78 L242,92 L225,88 L215,75 L218,62Z"/>
                    <!-- China / East Asia -->
                    <path d="M255,42 L285,38 L310,45 L320,58 L312,72 L295,78 L275,75 L258,78 L248,68 L250,52Z"/>
                    <!-- Southeast Asia -->
                    <path d="M265,82 L282,78 L298,88 L295,100 L280,105 L268,98Z"/>
                    <!-- Japan -->
                    <path d="M315,45 L325,42 L330,52 L325,60 L318,55Z"/>
                    <!-- Australia -->
                    <path d="M280,115 L305,108 L325,118 L332,135 L320,148 L295,150 L278,140 L275,125Z"/>
                    <!-- Indonesia -->
                    <path d="M268,105 L290,102 L305,108 L298,115 L278,112Z"/>
                </g>
            </svg>`;

            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            panel.innerHTML = `
                <div class="world-map">
                    ${worldMapSVG}
                    ${hotspotsHTML}
                    ${coordLabels}
                    <div class="map-corner-label tl">GLOBAL ACTIVITY MONITOR</div>
                    <div class="map-corner-label tr">CLASSIFICATION: OPEN SOURCE</div>
                    <div class="map-corner-label bl">PROJECTION: EQUIRECTANGULAR</div>
                    <div class="map-corner-label br">${timestamp}</div>
                </div>
            `;
        }

        // Fetch Congressional trades - uses news RSS since APIs are locked down
        async function fetchCongressTrades() {
            try {
                // Try Google News RSS for congress stock trading news
                const searchTerms = encodeURIComponent('congress stock trading pelosi tuberville');
                const rssUrl = `https://news.google.com/rss/search?q=${searchTerms}&hl=en-US&gl=US&ceid=US:en`;

                const text = await fetchWithProxy(rssUrl);
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                const items = xml.querySelectorAll('item');

                if (items.length > 0) {
                    const trades = extractTradesFromNews(Array.from(items).slice(0, 15));
                    if (trades.length >= 3) {
                        console.log('Congress trades extracted from news');
                        return trades;
                    }
                }
            } catch (e) {
                console.log('News fetch failed:', e.message);
            }

            // Fallback: Recent trades with dynamic dates
            return getRecentNotableTrades();
        }

        // Extract trade info from news headlines
        function extractTradesFromNews(items) {
            const trades = [];
            const members = {
                'pelosi': { name: 'Nancy Pelosi', party: 'D', district: 'CA-11' },
                'tuberville': { name: 'Tommy Tuberville', party: 'R', district: 'Senate' },
                'crenshaw': { name: 'Dan Crenshaw', party: 'R', district: 'TX-02' },
                'greene': { name: 'Marjorie Taylor Greene', party: 'R', district: 'GA-14' },
                'khanna': { name: 'Ro Khanna', party: 'D', district: 'CA-17' },
                'gottheimer': { name: 'Josh Gottheimer', party: 'D', district: 'NJ-05' },
                'mccaul': { name: 'Michael McCaul', party: 'R', district: 'TX-10' },
                'ossoff': { name: 'Jon Ossoff', party: 'D', district: 'Senate' },
                'cruz': { name: 'Ted Cruz', party: 'R', district: 'Senate' }
            };
            const tickers = ['NVDA', 'AAPL', 'MSFT', 'GOOGL', 'META', 'TSLA', 'AMZN', 'AMD', 'AVGO', 'CRM', 'PLTR'];

            items.forEach(item => {
                const title = (item.querySelector('title')?.textContent || '').toLowerCase();
                const pubDate = item.querySelector('pubDate')?.textContent || new Date().toISOString();

                for (const [key, member] of Object.entries(members)) {
                    if (title.includes(key)) {
                        const isBuy = title.includes('buy') || title.includes('purchase') || title.includes('bought');
                        const isSell = title.includes('sell') || title.includes('sold') || title.includes('sale');

                        let ticker = tickers.find(t => title.includes(t.toLowerCase())) || 'STOCK';

                        if (isBuy || isSell || title.includes('trade') || title.includes('stock')) {
                            trades.push({
                                ...member,
                                ticker,
                                type: isSell ? 'sell' : 'buy',
                                amount: 'Disclosed',
                                date: pubDate
                            });
                        }
                    }
                }
            });

            return trades.slice(0, 10);
        }

        // Fallback - recent trades with dynamically calculated dates
        function getRecentNotableTrades() {
            const today = new Date();
            const daysAgo = (n) => {
                const d = new Date(today);
                d.setDate(d.getDate() - n);
                return d.toISOString().split('T')[0];
            };

            // Real congressional traders known for active trading
            return [
                { name: 'Nancy Pelosi', party: 'D', ticker: 'NVDA', type: 'buy', amount: '$1M - $5M', date: daysAgo(2), district: 'CA-11' },
                { name: 'Tommy Tuberville', party: 'R', ticker: 'PLTR', type: 'buy', amount: '$250K - $500K', date: daysAgo(4), district: 'Senate' },
                { name: 'Dan Crenshaw', party: 'R', ticker: 'MSFT', type: 'buy', amount: '$100K - $250K', date: daysAgo(6), district: 'TX-02' },
                { name: 'Ro Khanna', party: 'D', ticker: 'GOOGL', type: 'buy', amount: '$50K - $100K', date: daysAgo(8), district: 'CA-17' },
                { name: 'Josh Gottheimer', party: 'D', ticker: 'META', type: 'buy', amount: '$100K - $250K', date: daysAgo(10), district: 'NJ-05' },
                { name: 'Marjorie Taylor Greene', party: 'R', ticker: 'TSLA', type: 'buy', amount: '$15K - $50K', date: daysAgo(12), district: 'GA-14' },
                { name: 'Michael McCaul', party: 'R', ticker: 'RTX', type: 'buy', amount: '$500K - $1M', date: daysAgo(14), district: 'TX-10' },
                { name: 'Nancy Pelosi', party: 'D', ticker: 'AAPL', type: 'sell', amount: '$500K - $1M', date: daysAgo(18), district: 'CA-11' },
                { name: 'Mark Green', party: 'R', ticker: 'LMT', type: 'buy', amount: '$50K - $100K', date: daysAgo(21), district: 'TN-07' },
                { name: 'Tommy Tuberville', party: 'R', ticker: 'XOM', type: 'buy', amount: '$100K - $250K', date: daysAgo(25), district: 'Senate' }
            ];
        }

        // Fetch whale transactions
        async function fetchWhaleTransactions() {
            try {
                // Use Blockchain.com API for recent large BTC transactions
                const text = await fetchWithProxy('https://blockchain.info/unconfirmed-transactions?format=json');
                const data = JSON.parse(text);

                // Filter for large transactions (> 10 BTC)
                const btcPrice = 100000; // Approximate, will be updated
                const whales = data.txs
                    .map(tx => {
                        const totalOut = tx.out.reduce((sum, o) => sum + o.value, 0) / 100000000;
                        return {
                            coin: 'BTC',
                            amount: totalOut,
                            usd: totalOut * btcPrice,
                            hash: tx.hash.substring(0, 8) + '...',
                            time: new Date(tx.time * 1000)
                        };
                    })
                    .filter(tx => tx.amount >= 10)
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 15);

                return whales;
            } catch (error) {
                console.error('Error fetching whale transactions:', error);
                // Fallback: simulate with placeholder data showing the feature
                return [];
            }
        }

        // Calculate "Main Character" from news headlines
        function calculateMainCharacter(allNews) {
            // Common names and figures to track
            const namePatterns = [
                { pattern: /\btrump\b/gi, name: 'Trump' },
                { pattern: /\bbiden\b/gi, name: 'Biden' },
                { pattern: /\belon\b|\bmusk\b/gi, name: 'Elon Musk' },
                { pattern: /\bputin\b/gi, name: 'Putin' },
                { pattern: /\bzelensky\b/gi, name: 'Zelensky' },
                { pattern: /\bxi\s*jinping\b|\bxi\b/gi, name: 'Xi Jinping' },
                { pattern: /\bnetanyahu\b/gi, name: 'Netanyahu' },
                { pattern: /\bsam\s*altman\b/gi, name: 'Sam Altman' },
                { pattern: /\bmark\s*zuckerberg\b|\bzuckerberg\b/gi, name: 'Zuckerberg' },
                { pattern: /\bjeff\s*bezos\b|\bbezos\b/gi, name: 'Bezos' },
                { pattern: /\btim\s*cook\b/gi, name: 'Tim Cook' },
                { pattern: /\bsatya\s*nadella\b|\bnadella\b/gi, name: 'Satya Nadella' },
                { pattern: /\bsundar\s*pichai\b|\bpichai\b/gi, name: 'Sundar Pichai' },
                { pattern: /\bwarren\s*buffett\b|\bbuffett\b/gi, name: 'Warren Buffett' },
                { pattern: /\bjanet\s*yellen\b|\byellen\b/gi, name: 'Janet Yellen' },
                { pattern: /\bjerome\s*powell\b|\bpowell\b/gi, name: 'Jerome Powell' },
                { pattern: /\bkamala\s*harris\b|\bharris\b/gi, name: 'Kamala Harris' },
                { pattern: /\bnancy\s*pelosi\b|\bpelosi\b/gi, name: 'Nancy Pelosi' },
                { pattern: /\bjensen\s*huang\b|\bhuang\b/gi, name: 'Jensen Huang' },
                { pattern: /\bdario\s*amodei\b|\bamodei\b/gi, name: 'Dario Amodei' }
            ];

            const counts = {};

            allNews.forEach(item => {
                const text = item.title.toLowerCase();
                namePatterns.forEach(({ pattern, name }) => {
                    const matches = text.match(pattern);
                    if (matches) {
                        counts[name] = (counts[name] || 0) + matches.length;
                    }
                });
            });

            // Sort by mentions
            const sorted = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            return sorted;
        }

        // Fetch government contracts from USAspending
        async function fetchGovContracts() {
            try {
                // USAspending API for recent contract awards
                const response = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_award/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filters: {
                            time_period: [{ start_date: getDateDaysAgo(7), end_date: getToday() }],
                            award_type_codes: ['A', 'B', 'C', 'D'] // Contracts only
                        },
                        fields: ['Award ID', 'Recipient Name', 'Award Amount', 'Awarding Agency', 'Description', 'Start Date'],
                        limit: 15,
                        order: 'desc',
                        sort: 'Award Amount'
                    })
                });

                const data = await response.json();

                return (data.results || []).map(c => ({
                    agency: c['Awarding Agency'] || 'Unknown Agency',
                    vendor: c['Recipient Name'] || 'Unknown',
                    amount: c['Award Amount'] || 0,
                    description: c['Description'] || 'Contract Award',
                    date: c['Start Date']
                }));
            } catch (error) {
                console.error('Error fetching contracts:', error);
                return [];
            }
        }

        function getDateDaysAgo(days) {
            const d = new Date();
            d.setDate(d.getDate() - days);
            return d.toISOString().split('T')[0];
        }

        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        // AI RSS feeds for arms race tracking
        const AI_FEEDS = [
            { name: 'OpenAI', url: 'https://openai.com/blog/rss.xml' },
            { name: 'Anthropic', url: 'https://www.anthropic.com/rss.xml' },
            { name: 'Google AI', url: 'https://blog.google/technology/ai/rss/' },
            { name: 'DeepMind', url: 'https://deepmind.google/blog/rss.xml' },
            { name: 'Meta AI', url: 'https://ai.meta.com/blog/rss/' },
            { name: 'Hugging Face', url: 'https://huggingface.co/blog/feed.xml' }
        ];

        async function fetchAINews() {
            const results = await Promise.all(AI_FEEDS.map(async (source) => {
                try {
                    const text = await fetchWithProxy(source.url);
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'text/xml');

                    let items = xml.querySelectorAll('item');
                    if (items.length === 0) items = xml.querySelectorAll('entry');

                    return Array.from(items).slice(0, 3).map(item => {
                        let link = '';
                        const linkEl = item.querySelector('link');
                        if (linkEl) link = linkEl.getAttribute('href') || linkEl.textContent || '';

                        return {
                            source: source.name,
                            title: item.querySelector('title')?.textContent?.trim() || 'No title',
                            link: link.trim(),
                            date: item.querySelector('pubDate')?.textContent ||
                                  item.querySelector('published')?.textContent || ''
                        };
                    });
                } catch (e) {
                    console.log(`Failed to fetch ${source.name}`);
                    return [];
                }
            }));

            return results.flat().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 15);
        }

        // Fetch Fed balance sheet from FRED
        async function fetchFedBalance() {
            try {
                // FRED API - Fed total assets (WALCL)
                const text = await fetchWithProxy('https://api.stlouisfed.org/fred/series/observations?series_id=WALCL&sort_order=desc&limit=10&file_type=json&api_key=DEMO');
                const data = JSON.parse(text);

                if (data.observations && data.observations.length >= 2) {
                    const latest = parseFloat(data.observations[0].value);
                    const previous = parseFloat(data.observations[1].value);
                    const change = latest - previous;
                    const changePercent = (change / previous) * 100;

                    // WALCL is in millions
                    return {
                        value: latest / 1000000, // Convert to trillions
                        change: change / 1000000,
                        changePercent,
                        date: data.observations[0].date,
                        // Historical high was ~9T in 2022
                        percentOfMax: (latest / 9000000) * 100
                    };
                }
            } catch (error) {
                console.error('Error fetching Fed balance:', error);
            }

            // Fallback with approximate current value
            return {
                value: 6.8,
                change: 0,
                changePercent: 0,
                date: new Date().toISOString().split('T')[0],
                percentOfMax: 75
            };
        }

        // Render functions for new panels
        function renderCongressTrades(trades) {
            const panel = document.getElementById('congressPanel');
            const count = document.getElementById('congressCount');

            if (trades.length === 0) {
                panel.innerHTML = '<div class="error-msg">Unable to load congressional trades</div>';
                count.textContent = '0';
                return;
            }

            panel.innerHTML = trades.map(t => `
                <div class="congress-item">
                    <div class="congress-info">
                        <div>
                            <span class="congress-name">${t.name}</span>
                            <span class="congress-party ${t.party}">${t.party}</span>
                        </div>
                        <div class="congress-ticker">${t.ticker}</div>
                        <div class="congress-meta">${timeAgo(t.date)} · ${t.district}</div>
                    </div>
                    <div class="congress-type">
                        <span class="congress-action ${t.type}">${t.type.toUpperCase()}</span>
                        <div class="congress-amount">${t.amount}</div>
                    </div>
                </div>
            `).join('');

            count.textContent = trades.length;
        }

        function renderWhaleWatch(whales) {
            const panel = document.getElementById('whalePanel');
            const count = document.getElementById('whaleCount');

            if (whales.length === 0) {
                panel.innerHTML = '<div class="error-msg">No whale transactions detected</div>';
                count.textContent = '0';
                return;
            }

            const formatAmount = (amt) => amt >= 1000 ? (amt / 1000).toFixed(1) + 'K' : amt.toFixed(2);
            const formatUSD = (usd) => {
                if (usd >= 1000000000) return '$' + (usd / 1000000000).toFixed(1) + 'B';
                if (usd >= 1000000) return '$' + (usd / 1000000).toFixed(1) + 'M';
                return '$' + (usd / 1000).toFixed(0) + 'K';
            };

            panel.innerHTML = whales.map(w => `
                <div class="whale-item">
                    <div class="whale-header">
                        <span class="whale-coin">${w.coin}</span>
                        <span class="whale-amount">${formatAmount(w.amount)} ${w.coin}</span>
                    </div>
                    <div class="whale-flow">
                        <span class="whale-usd">${formatUSD(w.usd)}</span>
                        <span class="arrow">→</span>
                        <span>${w.hash}</span>
                    </div>
                </div>
            `).join('');

            count.textContent = whales.length;
        }

        function renderMainCharacter(rankings) {
            const panel = document.getElementById('mainCharPanel');

            if (rankings.length === 0) {
                panel.innerHTML = '<div class="error-msg">No main character detected</div>';
                return;
            }

            const [topName, topCount] = rankings[0];

            panel.innerHTML = `
                <div class="main-char-display">
                    <div class="main-char-label">Today's Main Character</div>
                    <div class="main-char-name">${topName}</div>
                    <div class="main-char-count">${topCount} mentions in headlines</div>

                    <div class="main-char-list">
                        ${rankings.slice(1, 8).map((r, i) => `
                            <div class="char-row">
                                <span class="rank">${i + 2}.</span>
                                <span class="name">${r[0]}</span>
                                <span class="mentions">${r[1]}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderGovContracts(contracts) {
            const panel = document.getElementById('contractsPanel');
            const count = document.getElementById('contractsCount');

            if (contracts.length === 0) {
                panel.innerHTML = '<div class="error-msg">Unable to load contracts</div>';
                count.textContent = '0';
                return;
            }

            const formatValue = (v) => {
                if (v >= 1000000000) return '$' + (v / 1000000000).toFixed(1) + 'B';
                if (v >= 1000000) return '$' + (v / 1000000).toFixed(1) + 'M';
                if (v >= 1000) return '$' + (v / 1000).toFixed(0) + 'K';
                return '$' + v.toFixed(0);
            };

            panel.innerHTML = contracts.map(c => `
                <div class="contract-item">
                    <div class="contract-agency">${c.agency}</div>
                    <div class="contract-desc">${c.description.substring(0, 100)}${c.description.length > 100 ? '...' : ''}</div>
                    <div class="contract-meta">
                        <span class="contract-vendor">${c.vendor}</span>
                        <span class="contract-value">${formatValue(c.amount)}</span>
                    </div>
                </div>
            `).join('');

            count.textContent = contracts.length;
        }

        function renderAINews(items) {
            const panel = document.getElementById('aiPanel');
            const count = document.getElementById('aiCount');

            if (items.length === 0) {
                panel.innerHTML = '<div class="error-msg">Unable to load AI news</div>';
                count.textContent = '0';
                return;
            }

            panel.innerHTML = items.map(item => `
                <div class="ai-item">
                    <div class="ai-source">${item.source}</div>
                    <a class="ai-title item-title" href="${item.link}" target="_blank">${item.title}</a>
                    <div class="ai-date">${timeAgo(item.date)}</div>
                </div>
            `).join('');

            count.textContent = items.length;
        }

        function renderMoneyPrinter(data) {
            const panel = document.getElementById('printerPanel');

            const isExpanding = data.change > 0;
            const status = isExpanding ? 'PRINTER ON' : 'PRINTER OFF';

            panel.innerHTML = `
                <div class="printer-gauge">
                    <div class="printer-label">Federal Reserve Balance Sheet</div>
                    <div class="printer-value">
                        ${data.value.toFixed(2)}<span class="printer-unit">T USD</span>
                    </div>
                    <div class="printer-change ${isExpanding ? 'up' : 'down'}">
                        ${data.change >= 0 ? '+' : ''}${(data.change * 1000).toFixed(0)}B (${data.changePercent >= 0 ? '+' : ''}${data.changePercent.toFixed(2)}%) WoW
                    </div>
                    <div class="printer-bar">
                        <div class="printer-fill" style="width: ${Math.min(data.percentOfMax, 100)}%"></div>
                    </div>
                    <div class="printer-status">
                        <span class="printer-indicator ${isExpanding ? 'on' : 'off'}"></span>
                        ${status}
                    </div>
                </div>
            `;
        }

        // Fetch Polymarket predictions
        async function fetchPolymarket() {
            try {
                const text = await fetchWithProxy('https://gamma-api.polymarket.com/markets?closed=false&order=volume&ascending=false&limit=25');
                const data = JSON.parse(text);

                if (!Array.isArray(data)) {
                    console.error('Polymarket response is not an array');
                    return [];
                }

                // Parse markets with flexible field handling
                const markets = data
                    .filter(m => {
                        const vol = parseFloat(m.volume || m.volumeNum || 0);
                        return m.question && vol > 1000;
                    })
                    .slice(0, 15)
                    .map(m => {
                        // Handle different price formats
                        let yesPrice = 0;
                        if (m.outcomePrices && Array.isArray(m.outcomePrices)) {
                            yesPrice = parseFloat(m.outcomePrices[0]) || 0;
                        } else if (m.bestBid !== undefined) {
                            yesPrice = parseFloat(m.bestBid) || 0;
                        } else if (m.lastTradePrice !== undefined) {
                            yesPrice = parseFloat(m.lastTradePrice) || 0;
                        }

                        // Ensure price is in 0-1 range, convert to percentage
                        if (yesPrice > 1) yesPrice = yesPrice / 100;
                        const yesPct = Math.round(yesPrice * 100);

                        return {
                            question: m.question,
                            yes: yesPct,
                            volume: parseFloat(m.volume || m.volumeNum || 0),
                            slug: m.slug || m.id
                        };
                    });

                return markets;
            } catch (error) {
                console.error('Error fetching Polymarket:', error);
                return [];
            }
        }

        // Format relative time
        function timeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Render news items
        function renderNews(items, panelId, countId) {
            const panel = document.getElementById(panelId);
            const count = document.getElementById(countId);

            if (items.length === 0) {
                panel.innerHTML = '<div class="error-msg">Failed to load</div>';
                count.textContent = '0';
                return;
            }

            panel.innerHTML = items.map(item => `
                <div class="item ${item.isAlert ? 'alert' : ''}">
                    <div class="item-source">${item.source}${item.isAlert ? '<span class="alert-tag">ALERT</span>' : ''}</div>
                    <a class="item-title" href="${item.link}" target="_blank">${item.title}</a>
                    <div class="item-time">${timeAgo(item.pubDate)}</div>
                </div>
            `).join('');

            count.textContent = items.length;
        }

        // Render markets
        function renderMarkets(markets) {
            const panel = document.getElementById('marketsPanel');
            const count = document.getElementById('marketsCount');

            if (markets.length === 0) {
                panel.innerHTML = '<div class="error-msg">Failed to load</div>';
                count.textContent = '0';
                return;
            }

            panel.innerHTML = markets.map(m => {
                const changeClass = m.change > 0 ? 'up' : m.change < 0 ? 'down' : '';
                const changeText = m.change !== null ? `${m.change > 0 ? '+' : ''}${m.change.toFixed(2)}%` : '-';
                const priceDisplay = typeof m.price === 'number' && m.price > 100
                    ? m.price.toLocaleString('en-US', { maximumFractionDigits: 0 })
                    : m.price?.toFixed(2);

                return `
                    <div class="market-item">
                        <div>
                            <div class="market-name">${m.name}</div>
                            <div class="market-symbol">${m.symbol}</div>
                        </div>
                        <div class="market-data">
                            <div class="market-price">$${priceDisplay}</div>
                            <div class="market-change ${changeClass}">${changeText}</div>
                        </div>
                    </div>
                `;
            }).join('');

            count.textContent = markets.length;
        }

        // Render sector heatmap
        function renderHeatmap(sectors) {
            const panel = document.getElementById('heatmapPanel');

            if (sectors.length === 0) {
                panel.innerHTML = '<div class="error-msg">Failed to load</div>';
                return;
            }

            panel.innerHTML = '<div class="heatmap">' + sectors.map(s => {
                let colorClass = 'up-0';
                const c = s.change;
                if (c >= 2) colorClass = 'up-3';
                else if (c >= 1) colorClass = 'up-2';
                else if (c >= 0.5) colorClass = 'up-1';
                else if (c >= 0) colorClass = 'up-0';
                else if (c >= -0.5) colorClass = 'down-0';
                else if (c >= -1) colorClass = 'down-1';
                else if (c >= -2) colorClass = 'down-2';
                else colorClass = 'down-3';

                return `
                    <div class="heatmap-cell ${colorClass}">
                        <div class="sector-name">${s.name}</div>
                        <div class="sector-change">${s.change >= 0 ? '+' : ''}${s.change.toFixed(2)}%</div>
                    </div>
                `;
            }).join('') + '</div>';
        }

        // Render commodities
        function renderCommodities(commodities) {
            const panel = document.getElementById('commoditiesPanel');

            if (commodities.length === 0) {
                panel.innerHTML = '<div class="error-msg">Failed to load</div>';
                return;
            }

            panel.innerHTML = commodities.map(m => {
                const changeClass = m.change > 0 ? 'up' : m.change < 0 ? 'down' : '';
                const changeText = `${m.change > 0 ? '+' : ''}${m.change.toFixed(2)}%`;
                const priceDisplay = m.price?.toFixed(2);

                return `
                    <div class="market-item">
                        <div>
                            <div class="market-name">${m.name}</div>
                            <div class="market-symbol">${m.symbol}</div>
                        </div>
                        <div class="market-data">
                            <div class="market-price">${m.symbol === 'VIX' ? '' : '$'}${priceDisplay}</div>
                            <div class="market-change ${changeClass}">${changeText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Polymarket predictions
        function renderPolymarket(markets) {
            const panel = document.getElementById('polymarketPanel');
            const count = document.getElementById('polymarketCount');

            if (markets.length === 0) {
                panel.innerHTML = '<div class="error-msg">Failed to load predictions</div>';
                count.textContent = '0';
                return;
            }

            const formatVolume = (v) => {
                if (v >= 1000000) return '$' + (v / 1000000).toFixed(1) + 'M';
                if (v >= 1000) return '$' + (v / 1000).toFixed(0) + 'K';
                return '$' + v.toFixed(0);
            };

            panel.innerHTML = markets.map(m => `
                <div class="prediction-item">
                    <div>
                        <div class="prediction-question">${m.question}</div>
                        <div class="prediction-volume">Vol: ${formatVolume(m.volume)}</div>
                    </div>
                    <div class="prediction-odds">
                        <span class="prediction-yes">${m.yes}%</span>
                    </div>
                </div>
            `).join('');

            count.textContent = markets.length;
        }

        // Update status
        function setStatus(text, loading = false) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = loading ? 'status loading' : 'status';
        }

        // Staged refresh - loads critical data first for faster perceived startup
        async function refreshAll() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            setStatus('Loading critical...', true);

            let allNews = [];

            try {
                // STAGE 1: Critical data (news + markets) - loads first
                const stage1Promise = Promise.all([
                    isPanelEnabled('politics') ? fetchCategory(FEEDS.politics) : Promise.resolve([]),
                    isPanelEnabled('tech') ? fetchCategory(FEEDS.tech) : Promise.resolve([]),
                    isPanelEnabled('finance') ? fetchCategory(FEEDS.finance) : Promise.resolve([]),
                    isPanelEnabled('markets') ? fetchMarkets() : Promise.resolve([]),
                    isPanelEnabled('heatmap') ? fetchSectors() : Promise.resolve([])
                ]);

                const [politics, tech, finance, markets, sectors] = await stage1Promise;

                // Render Stage 1 immediately
                if (isPanelEnabled('politics')) renderNews(politics, 'politicsPanel', 'politicsCount');
                if (isPanelEnabled('tech')) renderNews(tech, 'techPanel', 'techCount');
                if (isPanelEnabled('finance')) renderNews(finance, 'financePanel', 'financeCount');
                if (isPanelEnabled('markets')) renderMarkets(markets);
                if (isPanelEnabled('heatmap')) renderHeatmap(sectors);

                allNews = [...politics, ...tech, ...finance];
                setStatus('Loading more...', true);

                // STAGE 2: Secondary data (gov, commodities, polymarket, printer, mainchar)
                const stage2Promise = Promise.all([
                    isPanelEnabled('gov') ? fetchCategory(FEEDS.gov) : Promise.resolve([]),
                    isPanelEnabled('commodities') ? fetchCommodities() : Promise.resolve([]),
                    isPanelEnabled('polymarket') ? fetchPolymarket() : Promise.resolve([]),
                    isPanelEnabled('printer') ? fetchFedBalance() : Promise.resolve({ value: 0, change: 0, changePercent: 0, percentOfMax: 0 })
                ]);

                const [gov, commodities, polymarket, fedBalance] = await stage2Promise;

                if (isPanelEnabled('gov')) {
                    renderNews(gov, 'govPanel', 'govCount');
                    allNews = [...allNews, ...gov];
                }
                if (isPanelEnabled('commodities')) renderCommodities(commodities);
                if (isPanelEnabled('polymarket')) renderPolymarket(polymarket);
                if (isPanelEnabled('printer')) renderMoneyPrinter(fedBalance);

                // Render map and main character with available news
                if (isPanelEnabled('map')) {
                    const activityData = analyzeHotspotActivity(allNews);
                    renderGlobalMap(activityData);
                }
                if (isPanelEnabled('mainchar')) {
                    const mainCharRankings = calculateMainCharacter(allNews);
                    renderMainCharacter(mainCharRankings);
                }

                setStatus('Loading extras...', true);

                // STAGE 3: Extra data (congress, whales, contracts, AI) - lowest priority
                const stage3Promise = Promise.all([
                    isPanelEnabled('congress') ? fetchCongressTrades() : Promise.resolve([]),
                    isPanelEnabled('whales') ? fetchWhaleTransactions() : Promise.resolve([]),
                    isPanelEnabled('contracts') ? fetchGovContracts() : Promise.resolve([]),
                    isPanelEnabled('ai') ? fetchAINews() : Promise.resolve([])
                ]);

                const [congressTrades, whales, contracts, aiNews] = await stage3Promise;

                if (isPanelEnabled('congress')) renderCongressTrades(congressTrades);
                if (isPanelEnabled('whales')) renderWhaleWatch(whales);
                if (isPanelEnabled('contracts')) renderGovContracts(contracts);
                if (isPanelEnabled('ai')) renderAINews(aiNews);

                const now = new Date();
                setStatus(`Updated ${now.toLocaleTimeString()}`);
            } catch (error) {
                console.error('Refresh error:', error);
                setStatus('Error updating');
            }

            btn.disabled = false;
        }

        // Initial load
        refreshAll();

        // Auto-refresh every 5 minutes
        setInterval(refreshAll, 5 * 60 * 1000);
    </script>
</body>
</html>
